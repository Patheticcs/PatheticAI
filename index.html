<!DOCTYPE html>
<html lang="en" data-theme="dark">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>PatheticAI Enhanced</title>
  <link rel="manifest" href="/manifest.json">
  <link href="https://api.fontshare.com/v2/css?f[]=cabinet-grotesk@700,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
  <meta name="description" content="PatheticAI - Advanced AI chatbot with enhanced features for seamless conversations and task automation">
  <meta name="keywords" content="AI, chatbot, machine learning, conversation, automation">
  <meta property="og:title" content="PatheticAI Enhanced">
  <meta property="og:description" content="Advanced AI chatbot with enhanced features for seamless conversations and task automation">
  <meta property="og:image" content="/icon.png">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="PatheticAI">
  <meta name="theme-color" content="#fff">
  <style>
   * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Cabinet Grotesk', sans-serif;
    scrollbar-width: none;
    -ms-overflow-style: none;
   }

   *::-webkit-scrollbar {
    display: none;
   }

   :root {
    --container-width: min(90%, 800px);
    --spacing-normal: clamp(16px, 2vw, 20px);
    --spacing-small: clamp(8px, 1vw, 10px);
    --border-radius: 30px;
    --border-radius-small: 15px;
    --transition: all 0.3s ease;
   }

   :root[data-theme="light"] {
    --background-color: #ffffff;
    --primary-color: #000000;
    --secondary-color: #9c00d5;
    --border-color: rgba(0, 0, 0, 0.05);
    --taskbar-background: rgba(255, 255, 255, 0.6);
    --input-background: rgba(255, 255, 255, 0.7);
    --button-background: rgba(0, 0, 0, 0.02);
    --button-hover-background: rgba(0, 0, 0, 0.05);
    --modal-background: rgba(255, 255, 255, 0.7);
    --message-background: rgba(255, 255, 255, 0.6);
    --message-user-background: rgba(255, 255, 255, 0.5);
    --code-background: rgba(0, 0, 0, 0.02);
    --code-text: #000000;
    --notification-background: rgba(255, 255, 255, 0.6);
    --notification-text: #000000;
    --placeholder-color: rgba(0, 0, 0, 0.2);
    --chat-input-container-background: rgba(255, 255, 255, 0.5);
   }

   :root[data-theme="dark"] {
    --background-color: #000000;
    --primary-color: #ffffff;
    --secondary-color: #9c00d5;
    --border-color: rgba(255, 255, 255, 0.03);
    --taskbar-background: rgba(0, 0, 0, 0.5);
    --input-background: rgba(0, 0, 0, 0.6);
    --button-background: rgba(255, 255, 255, 0.02);
    --button-hover-background: rgba(255, 255, 255, 0.05);
    --modal-background: rgba(0, 0, 0, 0.6);
    --message-background: rgba(0, 0, 0, 0.5);
    --message-user-background: rgba(0, 0, 0, 0.4);
    --code-background: rgba(255, 255, 255, 0.02);
    --code-text: #ffffff;
    --notification-background: rgba(0, 0, 0, 0.5);
    --notification-text: #ffffff;
    --placeholder-color: rgba(255, 255, 255, 0.2);
    --chat-input-container-background: rgba(0, 0, 0, 0.4);
   }

   body {
    background: url('https://wallpapers.com/images/hd/4k-nature-in-ice-wvdjbvbvxn12plp6.jpg') no-repeat center center fixed;
    background-size: cover;
    background-attachment: fixed;
    color: white;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: fixed;
    width: 100%;
    height: 100%;
    touch-action: none;
    -webkit-overflow-scrolling: none;
    overscroll-behavior: none;
   }

   .container {
    position: fixed;
    top: calc(60px + var(--spacing-normal) * 2);
    bottom: calc(60px + var(--spacing-normal) * 2);
    left: 50%;
    transform: translateX(-50%);
    width: var(--container-width);
    overflow-y: auto;
    padding-right: var(--spacing-small);
   }

   .taskbar {
    position: fixed;
    top: var(--spacing-normal);
    left: 50%;
    transform: translateX(-50%);
    width: var(--container-width);
    height: 60px;
    background: var(--taskbar-background);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 var(--spacing-normal);
    z-index: 1000;
    overflow-x: visible;
   }

   .taskbar-left {
    display: flex;
    align-items: center;
    gap: 10px;
   }

   .brand {
    font-size: 20px;
    font-weight: 700;
    cursor: pointer;
    color: var(--primary-color);
    transition: opacity 0.3s ease;
   }

   .brand:hover {
    opacity: 0.8;
   }

   .preview-tag {
    font-size: 14px;
    color: var(--primary-color);
    opacity: 0.7;
   }

   .taskbar button {
    background: var(--button-background);
    border: 1px solid var(--border-color);
    color: var(--primary-color);
    padding: 8px 15px;
    border-radius: 30px;
    cursor: pointer;
    margin-left: 10px;
    transition: all 0.3s ease;
   }

   .taskbar button:hover {
    background: var(--button-hover-background);
    transform: translateY(-1px);
   }

   .chat-input-container button,
   .theme-selector button {
    background: var(--button-background);
    border: 1px solid var(--border-color);
    color: var(--primary-color);
    padding: 8px 15px;
    border-radius: 30px;
    cursor: pointer;
    transition: all 0.3s ease;
   }

   .chat-input-container button:hover,
   .theme-selector button:hover {
    background: var(--button-hover-background);
    transform: translateY(-1px);
   }

   .chat-messages {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-normal);
    padding: var(--spacing-normal);
    height: 100%;
    overflow-y: auto;
   }

   .chat-message {
    padding: var(--spacing-normal);
    border-radius: var(--border-radius-small);
    max-width: 85%;
    white-space: pre-wrap;
    font-size: clamp(14px, 3vw, 16px);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    transition: var(--transition);
    color: var(--primary-color);
   }

   .chat-message.user {
    background: var(--message-user-background);
    align-self: flex-end;
    border-bottom-right-radius: 5px;
   }

   .chat-message.bot {
    background: var(--message-background);
    align-self: flex-start;
    border-bottom-left-radius: 5px;
    color: var(--primary-color);
   }

   .chat-input-container {
    position: fixed;
    bottom: var(--spacing-normal);
    left: 50%;
    transform: translateX(-50%);
    width: var(--container-width);
    display: flex;
    gap: var(--spacing-small);
    background: var(--taskbar-background);
    backdrop-filter: blur(10px);
    padding: var(--spacing-normal);
    border-radius: var(--border-radius);
    border: 1px solid var(--border-color);
   }

   .chat-input-container textarea {
    flex: 1;
    background: var(--input-background);
    border: none;
    outline: none;
    color: var(--primary-color);
    font-size: 16px;
    padding: var(--spacing-small);
    border-radius: var(--border-radius-small);
    resize: none;
    min-height: 40px;
   }

   .chat-input-container input::placeholder {
    color: rgba(255, 255, 255, 0.5);
   }

   .chat-input-container button {
    background: var(--button-background);
    border: 1px solid var(--border-color);
    color: var(--primary-color);
    padding: 8px 20px;
    border-radius: 30px;
    cursor: pointer;
    transition: all 0.3s ease;
   }

   .chat-input-container button:hover {
    background: var(--button-hover-background);
    transform: translateY(-1px);
   }

   button {
    background: var(--button-background);
    border: 1px solid var(--border-color);
    color: var(--primary-color);
    padding: 8px 15px;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: var(--transition);
   }

   button:hover {
    background: var(--button-hover-background);
    transform: translateY(-1px);
   }

   .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    animation: fadeIn 0.3s ease;
   }

   .modal-window {
    background: var(--modal-background);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    width: var(--container-width);
    padding: var(--spacing-normal);
    color: var(--primary-color);
    animation: slideUp 0.3s ease;
   }

   .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
   }

   .modal-title {
    font-size: 24px;
    font-weight: 700;
   }

   .modal-content {
    line-height: 1.6;
    font-size: 16px;
   }

   .modal-content p {
    margin: 5px 0;
   }

   .settings-content {
    display: flex;
    flex-direction: column;
    gap: 15px;
   }

   .settings-button {
    background: var(--button-background);
    border: 1px solid var(--border-color);
    padding: 15px;
    border-radius: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 10px;
   }

   .settings-button:hover {
    background: var(--button-hover-background);
    transform: translateX(5px);
   }

   .settings-button i {
    width: 20px;
    text-align: center;
   }

   .notification {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--background-color);
    color: var(--primary-color);
    padding: 12px 25px;
    border-radius: 30px;
    backdrop-filter: blur(10px);
    animation: slideUp 0.3s ease;
    z-index: 2000;
   }

   .notification.fade-out {
    animation: fadeOut 0.3s ease;
   }

   .code-block {
    background: rgba(0, 0, 0, 0.6);
    border-radius: 10px;
    padding: 15px;
    margin: 10px 0;
    position: relative;
   }

   .code-block pre {
    margin: 0;
    white-space: pre-wrap;
    font-family: 'Fira Code', monospace;
    color: #e0e0e0;
   }

   .copy-button {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid var(--border-color);
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    cursor: pointer;
    font-size: 12px;
   }

   .message-actions {
    display: flex;
    gap: 5px;
    margin-top: 5px;
    opacity: 0;
    transition: opacity 0.3s ease;
   }

   .chat-message:hover .message-actions {
    opacity: 1;
   }

   .action-button {
    background: var(--button-background);
    border: var(--border);
    color: var(--primary-color);
    padding: 3px 8px;
    border-radius: 12px;
    cursor: pointer;
    font-size: 12px;
   }

   .edit-mode {
    border: var(--border-color);
   }

   .edit-input {
    width: 100%;
    background: transparent;
    border: none;
    color: var(--primary-color);
    font-family: inherit;
    font-size: inherit;
    padding: 0;
    margin: 0;
    resize: none;
    outline: none;
   }

   .message-timestamp {
    font-size: 11px;
    opacity: 0.7;
    margin-top: 5px;
   }

   .container {
    position: fixed;
    top: calc(80px + var(--spacing-normal));
    bottom: calc(80px + var(--spacing-normal));
    left: 50%;
    transform: translateX(-50%);
    width: var(--container-width);
    max-width: var(--container-max-width);
    overflow-y: auto;
    padding-right: 15px;
   }

   .chat-messages {
    display: flex;
    flex-direction: column;
    gap: 15px;
    padding: 20px;
    padding-bottom: 40px;
    height: 100%;
    overflow-y: auto;
   }

   .chat-input-container {
    position: fixed;
    bottom: var(--spacing-normal);
    left: 50%;
    transform: translateX(-50%);
    width: var(--container-width);
    max-width: var(--container-max-width);
    display: flex;
    gap: 10px;
    background: var(--chat-input-container-background);
    backdrop-filter: blur(10px);
    padding: var(--spacing-normal);
    border-radius: 30px;
    border: 1px solid var(--border-color);
   }

   .chat-input-container textarea {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: var(--color);
    font-size: 16px;
    padding: 10px;
    border-radius: 10px;
    resize: none;
    min-height: 40px;
   }

   .chat-input-container input::placeholder {
    color: var(--color);
   }

   .chat-input-container button {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: var(--color);
    padding: 8px 20px;
    border-radius: 30px;
    cursor: pointer;
    transition: all 0.3s ease;
   }

   .chat-input-container button:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-1px);
   }

   .selector-container {
    position: relative;
    display: inline-block;
    width: 100%;
   }

   .selector {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-small) var(--spacing-normal);
    background-color: var(--button-background);
    border: 1px solid var(--border-color);
    cursor: pointer;
    border-radius: var(--border-radius);
    transition: background 0.3s ease;
    width: auto;
   }

   .selector i {
    font-size: 14px;
    transition: transform 0.3s ease;
   }

   .selector:hover {
    background-color: var(--button-hover-background);
   }

   .options {
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    display: none;
    background-color: var(--background-color);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
    z-index: 10;
   }

   .option {
    padding: var(--spacing-small);
    cursor: pointer;
    font-size: 14px;
    color: var(--primary-color);
    transition: background 0.3s ease;
   }

   .option:hover {
    background-color: var(--button-hover-background);
   }

   .options.active {
    display: block;
   }

   .option-description {
    display: inline-block;
    margin-left: 10px;
    white-space: nowrap;
    font-size: 12px;
    color: var(--secondary-color);
   }

   .selector.open i {
    transform: rotate(180deg);
   }

   @keyframes fadeIn {
    from {
     opacity: 0;
    }

    to {
     opacity: 1;
    }
   }

   @keyframes slideUp {
    from {
     transform: translateY(20px);
     opacity: 0;
    }

    to {
     transform: translateY(0);
     opacity: 1;
    }
   }

   @keyframes messageAppear {
    from {
     transform: translateY(10px);
     opacity: 0;
    }

    to {
     transform: translateY(0);
     opacity: 1;
    }
   }

   @keyframes fadeOut {
    to {
     opacity: 0;
     transform: translate(-50%, 20px);
    }
   }

   @media (max-width: 768px) {
    :root {
     --container-width: 95%;
     --spacing-normal: clamp(12px, 3vw, 15px);
     --spacing-small: clamp(6px, 2vw, 8px);
     --border-radius: 20px;
     --border-radius-small: 12px;
    }

    .chat-message {
     max-width: 90%;
     font-size: var(--font-size-base);
    }

    .chat-input-container {
     padding: calc(var(--spacing-small) * 1.5);
    }

    .chat-input-container textarea {
     font-size: var(--font-size-base);
    }

    button {
     min-height: 44px;
     min-width: 44px;
     padding: 10px 20px;
    }
   }

   @media (prefers-reduced-motion: reduce) {
    * {
     animation-duration: 0.01ms !important;
     animation-iteration-count: 1 !important;
     transition-duration: 0.01ms !important;
     scroll-behavior: auto !important;
    }
   }

   @media (prefers-contrast: more) {

    :root[data-theme="light"],
    :root[data-theme="dark"] {
     --border-color: currentColor;
     --button-background: transparent;
     --button-hover-background: currentColor;
    }
   }

   @media print {

    .chat-input-container,
    .taskbar {
     display: none !important;
    }

    .container {
     position: static;
     transform: none;
     overflow: visible;
     height: auto;
    }

    .chat-message {
     break-inside: avoid;
     page-break-inside: avoid;
    }
   }

   @media (max-width: 480px) {
    :root {
     --container-width: 98%;
     --spacing-normal: 10px;
     --spacing-small: 5px;
    }

    .taskbar {
     padding: 8px var(--spacing-normal);
    }

    .taskbar-right button {
     padding: 5px 10px;
     font-size: 13px;
    }

    .brand {
     font-size: 16px;
    }

    .preview-tag {
     font-size: 11px;
    }

    .chat-message {
     max-width: 90%;
     padding: 12px 15px;
    }

    .modal-window {
     padding: 15px;
    }

    .modal-title {
     font-size: 20px;
    }

    .modal-content {
     font-size: 14px;
    }

    .settings-button {
     padding: 12px;
     font-size: 14px;
    }

    .notification {
     font-size: 13px;
     padding: 10px 20px;
    }
   }

   @media (max-height: 600px) and (orientation: landscape) {
    .container {
     top: 70px;
     bottom: 70px;
    }

    .taskbar {
     height: 50px;
    }

    .chat-input-container {
     padding: 8px 15px;
    }

    .chat-message {
     padding: 10px 15px;
     margin-bottom: 8px;
    }
   }

   @media (hover: none) {

    .chat-input-container button,
    .taskbar button,
    .settings-button {
     transition: none;
    }

    .chat-input-container button:active,
    .taskbar button:active,
    .settings-button:active {
     background: rgba(255, 255, 255, 0.2);
    }
   }

   .chat-input-container input:disabled,
   .chat-input-container button:disabled {
    cursor: not-allowed;
    opacity: 0.5;
    transition: opacity 0.3s ease;
   }

   .chat-input-container button:disabled:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: none;
   }
</style>
</head>
<body>
  <div class="taskbar">
    <div class="taskbar-left">
      <span class="brand">PatheticAI</span>
      <span class="preview-tag">Enhanced Edition</span>
    </div>
    <div class="taskbar-right">
      <button onclick="showSettingsModal()" title="Settings">
        <i class="fas fa-cog"></i>
      </button>
      <button onclick="showAboutModal()" title="Join Discord">
        <i class="fa fa-user-group"></i>
      </button>
      <button onclick="contactEmail()" title="Join Discord">
        <i class="fa-brands fa-discord"></i>
      </button>
    </div>
  </div>
  <div class="container">
    <div class="chat-messages"></div>
  </div>
  <div class="chat-input-container">
    <textarea id="messageInput" placeholder="Type your message..." rows="1" maxlength="2000"></textarea>
    <button onclick="sendMessage()" title="Send Message">
      <i class="fas fa-paper-plane"></i>
      <span>â€Ž â€Ž â€Ž Send</span>
    </button>
  </div>
  <script>
const CONFIG = {
  MAX_RETRIES: 3,
  TYPING_SPEED: 50,
  MAX_CONTEXT_LENGTH: 10,
  SUGGESTION_COUNT: 4,
  API_TIMEOUT: 30000,
  STORAGE_KEYS: {
    THEME: 'theme',
    API_KEY: 'openRouterApiKey',
    MESSAGES: 'chatMessages',
    LANGUAGE: 'preferredLanguage',
    SETTINGS: 'userSettings'
  }
};

const MODELS = [{
  name: "google/gemini-2.0-flash-exp:free"
}, {
  name: "meta-llama/llama-3.2-3b-instruct:free"
}, {
  name: "qwen/qwen-2-7b-instruct:free"
}, {
  name: "microsoft/phi-3-medium-128k-instruct:free"
}, {
  name: "undi95/toppy-m-7b:free"
}, {
  name: "google/gemini-2.0-flash-thinking-exp:free"
}, {
  name: "microsoft/phi-3-mini-128k-instruct:free"
}]; // Removed duplicate entry

let STATE = {
  isWaitingForResponse: false,
  editingMessageId: null,
  voiceRecording: false,
  messageHistory: [],
  currentLanguage: 'English',
  theme: 'dark',
  selectedModel: MODELS[0].name,
  contextLength: 0,
  mediaRecorder: null,
  settings: {
    notifications: true,
    soundEffects: true,
    autoScroll: true
  }
};

const systemMessage = {
  role: "system",
  content: `You are PatheticAI Enhanced
        
        Key characteristics:
        - Friendly and empathetic AI assistant
        - Provides clear, concise responses
        - Adapts communication style to user needs
        - Offers helpful suggestions and insights
        - Maintains context awareness`
};

document.addEventListener('DOMContentLoaded', () => {
  initializeApp();
});

function initializeApp() {
  loadSavedState();
  initializeUI();
  initializePersonality();
  setupEventListeners();
  showWelcomeMessage();
  if (!checkAndStoreApiKey()) {
    disableInput();
  }
  initializeVoiceInput();
}

async function toggleVoiceInput() {
  const voiceButton = document.querySelector('.voice-input-button');
  const messageInput = document.getElementById('messageInput');
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!STATE.voiceRecording) {
    if (!SpeechRecognition) {
      showError('Your browser does not support the Web Speech API');
      return;
    }

    try {
      const recognition = new SpeechRecognition();
      recognition.continuous = false; // Set to true for ongoing transcription
      recognition.interimResults = true; // Show results as user speaks
      recognition.lang = 'en-US'; // Change this to the desired language

      STATE.recognition = recognition;

      recognition.onstart = () => {
        STATE.voiceRecording = true;
        voiceButton.classList.add('recording');
        showNotification('Voice recording started');
      };

      recognition.onresult = (event) => {
        let transcript = '';
        let interimTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const result = event.results[i];
          if (result.isFinal) {
            transcript += result[0].transcript; // Final transcript
          } else {
            interimTranscript += result[0].transcript; // Interim (ongoing) transcript
          }
        }

        // Update message input with the final or interim result
        messageInput.value = transcript || interimTranscript;

        // Ensure that the focus stays on the input field to capture new speech results
        messageInput.focus();
      };

      recognition.onerror = (event) => {
        showError('Speech recognition error');
        console.error('Speech recognition error:', event.error);
      };

      recognition.onend = () => {
        STATE.voiceRecording = false;
        voiceButton.classList.remove('recording');
        showNotification('Voice recording stopped');
      };

      recognition.start();
    } catch (error) {
      showError('Microphone access denied');
      voiceButton.disabled = true;
    }
  } else {
    if (STATE.recognition) {
      STATE.recognition.stop();
      STATE.voiceRecording = false;
      voiceButton.classList.remove('recording');
      showNotification('Voice recording stopped');
    }
  }
}


   function loadSavedState() {
    try {
     const savedMessages = localStorage.getItem(CONFIG.STORAGE_KEYS.MESSAGES);
     if (savedMessages) {
      STATE.messageHistory = JSON.parse(savedMessages);
      STATE.messageHistory = STATE.messageHistory.filter(msg => msg && msg.role && msg.content && msg.timestamp);
      const chatMessages = document.querySelector('.chat-messages');
      chatMessages.innerHTML = '';
      STATE.messageHistory.forEach(msg => {
       const isUser = msg.role === 'user';
       const {
        element
       } = createMessageElement(msg.content, isUser, new Date(msg.timestamp));
       chatMessages.appendChild(element);
      });
     } else {
      showWelcomeMessage();
     }
     const savedSettings = localStorage.getItem(CONFIG.STORAGE_KEYS.SETTINGS);
     if (savedSettings) {
      const parsedSettings = JSON.parse(savedSettings);
      STATE.settings = {
       ...STATE.settings,
       ...parsedSettings
      };
     }
     const savedTheme = localStorage.getItem(CONFIG.STORAGE_KEYS.THEME);
     if (savedTheme) {
      STATE.theme = savedTheme;
      document.documentElement.setAttribute('data-theme', savedTheme);
     }
     const savedLanguage = localStorage.getItem(CONFIG.STORAGE_KEYS.LANGUAGE);
     if (savedLanguage) {
      STATE.currentLanguage = savedLanguage;
     }
    } catch (error) {
     console.error('Error loading saved state:', error);
     STATE.messageHistory = [];
     saveToLocalStorage(CONFIG.STORAGE_KEYS.MESSAGES, []);
     showWelcomeMessage();
    }
   }

   function saveToLocalStorage(key, value) {
    try {
     const serializedValue = typeof value === 'string' ? value : JSON.stringify(value);
     localStorage.setItem(key, serializedValue);
     const savedValue = localStorage.getItem(key);
     if (!savedValue) {
      throw new Error('Verification failed: Saved value is null');
     }
     return true;
    } catch (error) {
     console.error('Local storage error:', error);
     if (error.name === 'QuotaExceededError') {
      showNotification('Storage limit reached. Some messages may not be saved.');
      if (key === CONFIG.STORAGE_KEYS.MESSAGES && Array.isArray(value)) {
       const recentMessages = value.slice(-50);
       try {
        localStorage.setItem(key, JSON.stringify(recentMessages));
        return true;
       } catch (e) {
        console.error('Failed to save recent messages:', e);
       }
      }
     }
     return false;
    }
   }

   function formatTimestamp(date) {
    return new Intl.DateTimeFormat('default', {
     hour: 'numeric',
     minute: 'numeric',
     second: 'numeric',
     year: 'numeric',
     month: 'short',
     day: 'numeric'
    }).format(date);
   }
   async function copyToClipboard(text) {
    try {
     await navigator.clipboard.writeText(text);
     showNotification('Copied to clipboard');
    } catch (err) {
     showNotification('Failed to copy to clipboard');
    }
   }

   function createMessageElement(message, isUser, timestamp = new Date()) {
    const messageId = Date.now().toString();
    const messageElement = document.createElement('div');
    messageElement.classList.add('chat-message', isUser ? 'user' : 'bot');
    messageElement.dataset.messageId = messageId;
    const contentDiv = document.createElement('div');
    contentDiv.classList.add('message-content');
    if (!isUser) {
     contentDiv.innerHTML = marked.parse(message);
     contentDiv.querySelectorAll('pre code').forEach((block) => {
      hljs.highlightElement(block);
     });
    } else {
     contentDiv.textContent = message;
    }
    messageElement.appendChild(contentDiv);
    const timestampDiv = document.createElement('div');
    timestampDiv.className = 'message-timestamp';
    timestampDiv.textContent = formatTimestamp(timestamp);
    messageElement.appendChild(timestampDiv);
    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'message-actions';
    if (isUser) {
     const editButton = document.createElement('button');
     editButton.className = 'action-button';
     editButton.innerHTML = '  <i class = "fas fa-edit" ></i>';
     editButton.onclick = () => startEditing(messageId);
     actionsDiv.appendChild(editButton);
    }
    const copyButton = document.createElement('button');
    copyButton.className = 'action-button';
    copyButton.innerHTML = '  <i class = "fas fa-copy" ></i>';
    copyButton.onclick = () => copyToClipboard(message);
    actionsDiv.appendChild(copyButton);
    messageElement.appendChild(actionsDiv);
    return {
     element: messageElement,
     id: messageId
    };
   }
   const PERSONALITIES = {
    Professional: {
     description: "Clear, helpful, and business-like responses",
     systemPrompt: "You are a professional AI assistant. Provide clear, concise, and formal responses."
    },
    Casual: {
     description: "Friendly and relaxed conversation style",
     systemPrompt: "You are a casual and friendly AI assistant. Use informal language and be conversational."
    },
    Poetic: {
     description: "Artistic and metaphorical communication",
     systemPrompt: "You are a poetic AI assistant. Express ideas with artistic flair and metaphorical language."
    },
    Rude: {
     description: "Sarcastic and slightly impatient",
     systemPrompt: "You are a sarcastic AI assistant. Be blunt and slightly impatient, but still helpful."
    },
    Witty: {
     description: "Clever and humorous responses",
     systemPrompt: "You are a witty AI assistant. Use wordplay and clever humor in your responses."
    },
    Academic: {
     description: "Scholarly and detailed explanations",
     systemPrompt: "You are an academic AI assistant. Provide detailed, well-structured responses with scholarly tone."
    },
    Enthusiastic: {
     description: "High-energy and encouraging",
     systemPrompt: "You are an enthusiastic AI assistant. Be energetic, positive, and encouraging in all responses."
    },
    Zen: {
     description: "Calm and mindful communication",
     systemPrompt: "You are a zen-like AI assistant. Provide peaceful, mindful responses with wisdom and tranquility."
    }
   };
   async function startEditing(messageId) {
    if (STATE.isWaitingForResponse) return;
    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
    if (!messageElement) return;
    const contentDiv = messageElement.querySelector('.message-content');
    const originalText = contentDiv.textContent;
    const textarea = document.createElement('textarea');
    textarea.className = 'edit-input';
    textarea.value = originalText;
    contentDiv.replaceWith(textarea);
    textarea.focus();
    messageElement.classList.add('edit-mode');
    STATE.editingMessageId = messageId;
    const handleEdit = async (e) => {
     if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      await finishEditing(messageId, textarea.value.trim());
     } else if (e.key === 'Escape') {
      finishEditing(messageId, originalText);
     }
    };
    textarea.addEventListener('keydown', handleEdit);
   }
   async function finishEditing(messageId, newText) {
    if (!messageId || !newText || STATE.isWaitingForResponse) return;
    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
    if (!messageElement) return;
    const textarea = messageElement.querySelector('.edit-input');
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    contentDiv.textContent = newText;
    textarea.replaceWith(contentDiv);
    messageElement.classList.remove('edit-mode');
    const messageIndex = STATE.messageHistory.findIndex(msg => msg.id === messageId);
    if (messageIndex === -1) return;
    STATE.messageHistory[messageIndex].content = newText;
    const nextIndex = messageIndex + 1;
    if (nextIndex < STATE.messageHistory.length && STATE.messageHistory[nextIndex].role === 'assistant') {
     STATE.messageHistory.splice(nextIndex, 1);
     const nextElement = messageElement.nextElementSibling;
     if (nextElement) nextElement.remove();
    }
    try {
     STATE.isWaitingForResponse = true;
     const response = await sendMessageWithRetry(newText);
     if (response.text) {
      const botMessageObj = {
       role: "assistant",
       content: response.text,
       timestamp: Date.now(),
       replyTo: messageId
      };
      STATE.messageHistory.splice(nextIndex, 0, botMessageObj);
      const {
       element: botElement
      } = createMessageElement(response.text, false);
      messageElement.after(botElement);
      if (STATE.settings.autoScroll) {
       botElement.scrollIntoView({
        behavior: 'smooth'
       });
      }
      if (STATE.settings.soundEffects) {
       playMessageSound();
      }
     }
    } catch (error) {
     showError(`Error updating response: ${error.message}`);
    } finally {
     STATE.isWaitingForResponse = false;
     STATE.editingMessageId = null;
    }
    saveToLocalStorage(CONFIG.STORAGE_KEYS.MESSAGES, STATE.messageHistory);
   }
   document.getElementById('messageInput').addEventListener('keydown', function(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
     event.preventDefault();
     sendMessage();
    }
   });

   function changePersonality(personality) {
    STATE.personality = personality;
    systemMessage.content = PERSONALITIES[personality].systemPrompt;
    const descriptionElement = document.querySelector('.personality-description');
    if (descriptionElement) {
     descriptionElement.textContent = PERSONALITIES[personality].description;
    }
    saveToLocalStorage('chatPersonality', personality);
    showNotification(`Personality changed to ${personality}`);
   }

   function initializePersonality() {
    const savedPersonality = localStorage.getItem('chatPersonality');
    if (savedPersonality && PERSONALITIES[savedPersonality]) {
     STATE.personality = savedPersonality;
     systemMessage.content = PERSONALITIES[savedPersonality].systemPrompt;
    }
   }
   async function sendMessage() {
    const textarea = document.getElementById('messageInput');
    const message = textarea.value.trim();
    if (!message || STATE.isWaitingForResponse || STATE.editingMessageId) return;
    STATE.isWaitingForResponse = true;
    disableInput();
    const timestamp = new Date();
    const {
     element: messageElement,
     id: messageId
    } = createMessageElement(message, true, timestamp);
    document.querySelector('.chat-messages').appendChild(messageElement);
    const messageObj = {
     role: "user",
     content: message,
     timestamp: timestamp.getTime(),
     id: messageId
    };
    STATE.messageHistory.push(messageObj);
    saveToLocalStorage(CONFIG.STORAGE_KEYS.MESSAGES, STATE.messageHistory);
    textarea.value = '';
    textarea.style.height = 'auto';
    try {
     const response = await sendMessageWithRetry(message);
     if (response.text) {
      const botMessageObj = {
       role: "assistant",
       content: response.text,
       timestamp: Date.now(),
       replyTo: messageId
      };
      STATE.messageHistory.push(botMessageObj);
      saveToLocalStorage(CONFIG.STORAGE_KEYS.MESSAGES, STATE.messageHistory);
      const {
       element: botElement
      } = createMessageElement(response.text, false);
      document.querySelector('.chat-messages').appendChild(botElement);
      if (STATE.settings.autoScroll) {
       botElement.scrollIntoView({
        behavior: 'smooth'
       });
      }
      if (STATE.settings.soundEffects) {
       playMessageSound();
      }
     }
    } catch (error) {
     showError(`Error: ${error.message}`);
    } finally {
     STATE.isWaitingForResponse = false;
     enableInput();
     textarea.focus();
    }
   }
   async function sendMessageWithRetry(message, retries = CONFIG.MAX_RETRIES) {
    try {
     const response = await tryMultipleModels(message);
     return response;
    } catch (error) {
     if (retries > 0) {
      showNotification(`Retrying... (${retries} attempts left)`);
      await new Promise(resolve => setTimeout(resolve, 1000));
      return sendMessageWithRetry(message, retries - 1);
     }
     throw error;
    }
   }
   async function tryMultipleModels(userMessage) {
    const apiKey = getApiKey();
    if (!apiKey) {
     throw new Error("API key not found. Please enter your API key first.");
    }
    for (let modelIndex = 0; modelIndex < MODELS.length; modelIndex++) {
     try {
      const response = await Promise.race([
       fetch("https://openrouter.ai/api/v1/chat/completions", {
        method: "POST",
        headers: {
         "Authorization": `Bearer ${apiKey}`,
         "Content-Type": "application/json"
        },
        body: JSON.stringify({
         "model": MODELS[modelIndex].name,
         "messages": [
          systemMessage, ...STATE.messageHistory.filter(msg => msg.role === "user" || msg.role === "assistant"), {
           role: "user",
           content: `Please respond in ${STATE.currentLanguage}. ${userMessage}`
          }
         ]
        })
       }).then(async res => {
        if (!res.ok) {
         const errorData = await res.json();
         throw new Error(`API Error: ${errorData.error?.message || 'Unknown error'}`);
        }
        return res.json();
       }),
       new Promise((_, reject) => setTimeout(() => reject(new Error('Request timeout')), CONFIG.API_TIMEOUT))
      ]);
      if (response.choices && response.choices[0].message.content) {
       return {
        text: response.choices[0].message.content
       };
      }
     } catch (error) {
      console.error(`Model ${MODELS[modelIndex].name} failed:`, error);
      if (modelIndex === MODELS.length - 1) {
       throw new Error(`API Error: ${error.message}`);
      }
      continue;
     }
    }
    throw new Error("All API attempts failed. Please try again later.");
   }
    async function toggleVoiceInput() {
      const voiceButton = document.querySelector('.voice-input-button');
      const messageInput = document.getElementById('messageInput');
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

      if (!STATE.voiceRecording) {
        if (!SpeechRecognition) {
          showError('Your browser does not support the Web Speech API');
          return;
        }

        try {
          const recognition = new SpeechRecognition();
          recognition.continuous = false; // Set to true for ongoing transcription
          recognition.interimResults = true; // Show results as user speaks
          recognition.lang = 'en-US'; // Set language to English

          STATE.recognition = recognition;

          recognition.onstart = () => {
            STATE.voiceRecording = true;
            voiceButton.classList.add('recording');
            showNotification('Voice recording started');
          };

          recognition.onresult = (event) => {
            let transcript = '';
            let interimTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
              const result = event.results[i];
              if (result.isFinal) {
                transcript += result[0].transcript; // Final transcript
              } else {
                interimTranscript += result[0].transcript; // Interim (ongoing) transcript
              }
            }

            // Update message input with the final or interim result
            messageInput.value = transcript || interimTranscript;
            messageInput.focus(); // Keep the input field focused
          };

          recognition.onerror = (event) => {
            showError('Speech recognition error');
            console.error('Speech recognition error:', event.error);
          };

          recognition.onend = () => {
            STATE.voiceRecording = false;
            voiceButton.classList.remove('recording');
            showNotification('Voice recording stopped');
          };

          recognition.start();
        } catch (error) {
          showError('Microphone access denied');
          voiceButton.disabled = true;
        }
      } else {
        if (STATE.recognition) {
          STATE.recognition.stop();
          STATE.voiceRecording = false;
          voiceButton.classList.remove('recording');
          showNotification('Voice recording stopped');
        }
      }
    }

    function initializeVoiceInput() {
      const chatInput = document.querySelector('.chat-input-container');
      if (chatInput) {
        const voiceButton = document.createElement('button');
        voiceButton.className = 'voice-input-button';
        voiceButton.innerHTML = '<i class="fas fa-microphone"></i> Start Voice Input';
        voiceButton.title = 'Voice Input';
        voiceButton.onclick = toggleVoiceInput;
        chatInput.insertBefore(voiceButton, chatInput.lastElementChild);
      }
    }


   function setupEventListeners() {
    window.addEventListener('focus', handleWindowFocus);
    window.addEventListener('blur', handleWindowBlur);
    window.addEventListener('online', () => showNotification('You are back online!'));
    window.addEventListener('offline', () => showNotification('You are offline. Some features may be unavailable.'));
    window.addEventListener('beforeunload', handleBeforeUnload);
    document.querySelector('.container').addEventListener('wheel', handleScroll);
    document.querySelector('.brand').addEventListener('click', showAboutModal);
    window.addEventListener('resize', handleResize);
   }

   function handleWindowFocus() {
    if (STATE.settings.notifications) {
     document.title = 'PatheticAI Enhanced';
    }
   }

   function handleWindowBlur() {
    if (STATE.settings.notifications) {
     const unreadMessages = STATE.messageHistory.filter(msg => msg.role === 'assistant' && msg.timestamp > document.lastModified).length;
     if (unreadMessages > 0) {
      document.title = `(${unreadMessages}) PatheticAI Enhanced`;
     }
    }
   }

   function handleBeforeUnload(e) {
    if (STATE.isWaitingForResponse || STATE.editingMessageId) {
     e.preventDefault();
     e.returnValue = '';
    }
   }

   function handleScroll(e) {
    if (STATE.settings.autoScroll) {
     const container = document.querySelector('.container');
     const isScrolledToBottom = container.scrollHeight - container.clientHeight <= container.scrollTop + 1;
     if (!isScrolledToBottom) {
      STATE.settings.autoScroll = false;
      showNotification('Auto-scroll disabled');
      saveToLocalStorage(CONFIG.STORAGE_KEYS.SETTINGS, STATE.settings);
     }
    }
   }

   function handleResize() {
    const textarea = document.getElementById('messageInput');
    if (textarea) {
     textarea.style.height = 'auto';
     textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
    }
   }

   function showSettingsModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    const personalityOptions = Object.keys(PERSONALITIES).map(p => `
            
        
																	<div class="option" data-personality="${p}" onclick="changePersonality('${p}')">${p}</div>
          `).join('');
    const languageOptions = ['English', 'Spanish', 'French', 'German', 'Italian', 'Japanese', 'Chinese', 'Russian', 'Portuguese', 'Korean', 'Hindi', 'Arabic'].map(lang => `
              
        
																	<div class="option" data-language="${lang}" onclick="changeLanguage('${lang}')">${lang}</div>
            `).join('');
    const themeOptions = `
            
        
																	<div class="option" data-theme="light" onclick="changeTheme('light')">Light</div>
																	<div class="option" data-theme="dark" onclick="changeTheme('dark')">Dark</div>
          `;
    modal.innerHTML = `
            
        
																	<div class="modal-window">
																		<div class="modal-header">
																			<span class="modal-title">Settings</span>
																			<button class="close-button" aria-label="Close settings" onclick="closeModal()">âœ–</button>
																		</div>
																		<div class="modal-content">
																			<div class="settings-section">
																				<div class="settings-button" onclick="resetChat()">
																					<i class="fa fa-trash"></i> Clear Chat
        
																				</div>
																			</div>
																			<div class="settings-section">
																				<div class="selector-container">
																					<div class="selector" id="personalitySelector" onclick="togglePersonalitySelector()">
																						<span>Personality: ${PERSONALITIES[STATE.personality]?.name || 'Select Personality'}</span>
																						<i class="fa fa-chevron-down"></i>
																					</div>
																					<div class="options" id="personalityOptions" style="display:none;">
                      ${personalityOptions}
                    </div>
																					<div id="personalityDescription" class="option-description">
                      ${PERSONALITIES[STATE.personality]?.description || 'Select a personality to view the description.'}
                    </div>
																				</div>
																			</div>
																			<div class="settings-section">
																				<div class="selector-container">
																					<div class="selector" id="languageSelector" onclick="toggleLanguageSelector()">
																						<span>Language: ${STATE.currentLanguage}</span>
																						<i class="fa fa-chevron-down"></i>
																					</div>
																					<div class="options" id="languageOptions" style="display:none;">
                      ${languageOptions}
                    </div>
																				</div>
																			</div>
																			<div class="settings-section">
																				<div class="settings-button" onclick="toggleSetting('notifications')">
																					<i class="fas fa-bell"></i> Notifications: ${STATE.settings.notifications ? 'On' : 'Off'}
        
																				</div>
																				<div class="settings-button" onclick="toggleSetting('soundEffects')">
																					<i class="fas fa-volume-up"></i> Sound Effects: ${STATE.settings.soundEffects ? 'On' : 'Off'}
                  
        
																				</div>
																				<div class="settings-button" onclick="toggleSetting('autoScroll')">
																					<i class="fas fa-scroll"></i> Auto Scroll: ${STATE.settings.autoScroll ? 'On' : 'Off'}
        
																				</div>
																				<div class="settings-button" onclick="removeApiKey()">
																					<i class="fas fa-key"></i> Remove API Key
        
																				</div>
																			</div>
																			<div class="settings-section">
																				<div class="selector-container">
																					<div class="selector" id="themeSelector" onclick="toggleThemeSelector()">
																						<span>Select Theme</span>
																						<i class="fa fa-chevron-down"></i>
																					</div>
																					<div class="options" id="themeOptions">
                      ${themeOptions}
                    </div>
																				</div>
																			</div>
																		</div>
																	</div>
          `;
    modal.addEventListener('click', (e) => {
     if (e.target === modal) {
      closeModal();
     }
    });
    document.body.appendChild(modal);
   }

   function closeModal() {
    document.querySelector('.modal-overlay').remove();
   }

   function togglePersonalitySelector() {
    const options = document.getElementById('personalityOptions');
    options.style.display = options.style.display === 'none' || options.style.display === '' ? 'block' : 'none';
   }

   function toggleLanguageSelector() {
    const options = document.getElementById('languageOptions');
    options.style.display = options.style.display === 'none' || options.style.display === '' ? 'block' : 'none';
   }

   function toggleThemeSelector() {
    const themeOptions = document.getElementById('themeOptions');
    themeOptions.style.display = themeOptions.style.display === 'none' || themeOptions.style.display === '' ? 'block' : 'none';
   }

   function changePersonality(personality) {
    STATE.personality = personality;
    const personalityDescription = document.getElementById('personalityDescription');
    const personalitySelector = document.getElementById('personalitySelector').querySelector('span');
    personalityDescription.textContent = PERSONALITIES[personality]?.description || 'Select a personality to view the description.';
    personalitySelector.textContent = `Personality: ${PERSONALITIES[personality]?.name || 'Select Personality'}`;
    saveToLocalStorage(CONFIG.STORAGE_KEYS.PERSONALITY, personality);
    showNotification(`Personality changed to ${PERSONALITIES[personality]?.name || 'unknown'}`);
   }

   function changeLanguage(language) {
    STATE.currentLanguage = language;
    const languageSelector = document.getElementById('languageSelector').querySelector('span');
    languageSelector.textContent = `Language: ${language}`;
    showNotification(`Language changed to ${language}`);
   }

   function changeTheme(theme) {
    STATE.theme = theme;
    document.documentElement.setAttribute('data-theme', theme);
    saveToLocalStorage(CONFIG.STORAGE_KEYS.THEME, theme);
    const themeSelector = document.getElementById('themeSelector').querySelector('span');
    themeSelector.textContent = `Theme: ${theme}`;
    document.getElementById('themeOptions').style.display = 'none';
    showNotification(`Theme changed to ${theme}`);
   }

   function toggleSetting(setting) {
    STATE.settings[setting] = !STATE.settings[setting];
    saveToLocalStorage(CONFIG.STORAGE_KEYS.SETTINGS, STATE.settings);
    const settingButton = document.querySelector(`[onclick="toggleSetting('${setting}')"]`);
    if (settingButton) {
     settingButton.textContent = `${setting.charAt(0).toUpperCase() + setting.slice(1)}: ${STATE.settings[setting] ? 'On' : 'Off'}`;
    }
    showNotification(`${setting} ${STATE.settings[setting] ? 'enabled' : 'disabled'}`);
    closeModal();
    showSettingsModal();
   }

   function resetChat() {
    STATE.messageHistory = [];
    saveToLocalStorage(CONFIG.STORAGE_KEYS.MESSAGES, []);
    document.querySelector('.chat-messages').innerHTML = '';
    showNotification('Chat history cleared');
    showWelcomeMessage();
   }

   function showWelcomeMessage() {
    const welcomeMessage = "ðŸ‘‹ Welcome to PatheticAI Enhanced! I'm here to help you with any questions or tasks you may have. Feel free to start our conversation!";
    const {
     element
    } = createMessageElement(welcomeMessage, false);
    document.querySelector('.chat-messages').appendChild(element);
   }

   function playMessageSound() {
    if (!STATE.settings.soundEffects) return;
    const audio = new Audio('notification.mp3');
    audio.volume = 0.5;
    audio.play().catch(err => console.log('Error playing sound', err));
   }

   function initializeTheme() {
    const savedTheme = localStorage.getItem(CONFIG.STORAGE_KEYS.THEME) || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    STATE.theme = savedTheme;
   }

   function showAboutModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
            
        
																	<div class="modal-window">
																		<div class="modal-header">
																			<span class="modal-title">About PatheticAI</span>
																			<button class="close-button" onclick="this.closest('.modal-overlay').remove()">âœ–</button>
																		</div>
																		<div class="modal-content">
																			<p>
																				<strong>PatheticAI:</strong> 1.0 Enhanced
        
																			</p>
																			<p>
																				<strong>API version:</strong> 1.0
        
																			</p>
																			<p>
																				<strong>Contact:</strong>
																				<a href="discord.gg/Hb5ccPY3XV">discord.gg/Hb5ccPY3XVm</a>
																			</p>
																			<br>
																				<p>
																					<strong>Enhanced Features:</strong>
																				</p>
																				<ul>
																					<li>Improved message handling</li>
																					<li>Better code display and copying</li>
																					<li>Theme customization</li>
																					<li>Advanced editing capabilities</li>
																					<li>Persistent chat history</li>
																				</ul>
																			</div>
																		</div>
          `;
    modal.addEventListener('click', (e) => {
     if (e.target === modal) {
      modal.remove();
     }
    });
    document.body.appendChild(modal);
   }

   function checkAndStoreApiKey() {
    const storedApiKey = getApiKey();
    if (!storedApiKey) {
     const modal = document.createElement('div');
     modal.className = 'modal-overlay';
     modal.innerHTML = `
              
        
																		<div class="modal-window">
																			<div class="modal-header">
																				<span class="modal-title">Openrouter API key required!</span>
																			</div>
																			<div class="modal-content">
																				<p>To use PatheticAI, an API key from Openrouter is required. To get this, go to</p>
																				<a href="https://openrouter.ai/settings/keys" target="_blank" style="color: white;">https:
                  
        
																					<br>
																						<br>
																							<input type="text" id="apiKeyInput" placeholder="Your API Key Here" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 15px; color: white;">
																								<br>
																									<br>
																										<button id="startupButton" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 15px; color: white; cursor: pointer;">Start up</button>
																									</div>
																								</div>
            `;
     document.body.appendChild(modal);
     document.getElementById('startupButton').addEventListener('click', saveApiKey);
     return false;
    }
    return true;
   }

   function saveApiKey() {
    const apiKey = document.getElementById('apiKeyInput').value.trim();
    if (apiKey && apiKey.startsWith('sk-or-')) {
     localStorage.setItem('openRouterApiKey', apiKey);
     document.querySelector('.modal-overlay').remove();
     showNotification('Booting...');
     setTimeout(() => {
      window.location.reload();
     }, 1000);
    } else {
     showNotification('API key not suitable for PatheticAI...');
    }
   }

   function removeApiKey() {
    localStorage.removeItem('openRouterApiKey');
    disableInput();
    showNotification('API key removed');
   }

   function disableInput() {
    const textarea = document.getElementById('messageInput');
    const sendButton = document.querySelector('.chat-input-container button');
    textarea.disabled = true;
    sendButton.disabled = true;
    textarea.placeholder = 'Please enter API key in settings...';
   }

   function enableInput() {
    const textarea = document.getElementById('messageInput');
    const sendButton = document.querySelector('.chat-input-container button');
    textarea.disabled = false;
    sendButton.disabled = false;
    textarea.placeholder = 'Type your message...';
   }

   function showNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => {
     notification.classList.add('fade-out');
     setTimeout(() => notification.remove(), 300);
    }, 2000);
   }

   function showWelcomeMessage() {
    const welcomeMessage = "ðŸ‘‹ Welcome to PatheticAI Enhanced! I'm here to help you with any questions or tasks you may have. Feel free to start our conversation!";
    const {
     element
    } = createMessageElement(welcomeMessage, false);
    document.querySelector('.chat-messages').appendChild(element);
   }

   function getApiKey() {
    const apiKey = localStorage.getItem('openRouterApiKey');
    if (apiKey && apiKey.startsWith('sk-or-')) {
     return apiKey;
    }
    return null;
   }

   function initializeUI() {
    console.log("UI Initialized with Theme:", STATE.theme);
    console.log("Current Language:", STATE.currentLanguage);
   }

   function contactEmail() {
    window.open('https://discord.gg/Hb5ccPY3XV', '_blank');
   }

   function setupEventListeners() {}
  </script>
