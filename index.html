<!DOCTYPE html>
<html lang="en" data-theme="dark">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<title>PatheticAI</title>
		<link rel="manifest" href="/manifest.json">
		<link href="https://api.fontshare.com/v2/css?f[]=cabinet-grotesk@700,400&display=swap" rel="stylesheet">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/default.min.css">
		<meta name="description" content="PatheticAI is an AI chatbot designed to assist, automate tasks, and provide real-time conversations with users.">
		<meta property="og:description" content="PatheticAI is an AI chatbot designed to assist, automate tasks, and provide real-time conversations with users.">
		<meta property="og:title" content="Pathetic">
		<meta property="og:image" content="/icon.png">
		<meta property="og:type" content="website">
		<meta property="og:site_name" content="PatheticAI">
		<meta property="og:locale" content="en_US">
		<link rel="icon" href="/icon.png" type="image/png">
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
				font-family: 'Cabinet Grotesk', sans-serif;
				scrollbar-width: none;
				-ms-overflow-style: none;
			}

			*::-webkit-scrollbar {
				display: none;
			}

			:root {
				--container-width: min(90%, 800px);
				--spacing-normal: clamp(16px, 2vw, 20px);
				--spacing-small: clamp(8px, 1vw, 10px);
				--border-radius: 30px;
				--border-radius-small: 15px;
				--transition: all 0.3s ease;
			}

			:root[data-theme="light"] {
				--background-color: #ffffff;
				--primary-color: #000000;
				--secondary-color: #000000;
				--border-color: rgba(0, 0, 0, 0.1);
				--taskbar-background: rgba(255, 255, 255, 0.8);
				--input-background: rgba(255, 255, 255, 0.9);
				--button-background: rgba(0, 0, 0, 0.1);
				--button-hover-background: rgba(0, 0, 0, 0.2);
				--modal-background: rgba(255, 255, 255, 0.9);
				--message-background: rgba(255, 255, 255, 0.9);
				--message-user-background: rgba(255, 255, 255, 0.8);
				--code-background: rgba(0, 0, 0, 0.1);
				--code-text: #000000;
				--notification-background: rgba(255, 255, 255, 0.8);
				--notification-text: #000000;
				--placeholder-color: rgba(0, 0, 0, 0.5);
				--chat-input-container-background: rgba(255, 255, 255, 0.6);
			}

			:root[data-theme="dark"] {
				--background-color: #000000;
				--primary-color: #ffffff;
				--secondary-color: #9c00d5;
				--border-color: rgba(255, 255, 255, 0.1);
				--taskbar-background: rgba(0, 0, 0, 0.8);
				--input-background: rgba(0, 0, 0, 0.9);
				--button-background: rgba(255, 255, 255, 0.1);
				--button-hover-background: rgba(255, 255, 255, 0.2);
				--modal-background: rgba(0, 0, 0, 0.9);
				--message-background: rgba(0, 0, 0, 0.8);
				--message-user-background: rgba(0, 0, 0, 0.7);
				--code-background: rgba(255, 255, 255, 0.1);
				--code-text: #ffffff;
				--notification-background: rgba(0, 0, 0, 0.8);
				--notification-text: #ffffff;
				--placeholder-color: rgba(255, 255, 255, 0.5);
				--chat-input-container-background: rgba(0, 0, 0, 0.6);
			}

			body {
				background: url('https://wallpapers.com/images/hd/4k-nature-in-ice-wvdjbvbvxn12plp6.jpg') no-repeat center center fixed;
				background-size: cover;
				background-attachment: fixed;
				color: white;
				min-height: 100vh;
				display: flex;
				flex-direction: column;
				overflow: hidden;
				position: fixed;
				width: 100%;
				height: 100%;
				touch-action: none;
				-webkit-overflow-scrolling: none;
				overscroll-behavior: none;
			}

			.container {
				position: fixed;
				top: calc(60px + var(--spacing-normal) * 2);
				bottom: calc(60px + var(--spacing-normal) * 2);
				left: 50%;
				transform: translateX(-50%);
				width: var(--container-width);
				overflow-y: auto;
				padding-right: var(--spacing-small);
			}

			.taskbar {
				position: fixed;
				top: var(--spacing-normal);
				left: 50%;
				transform: translateX(-50%);
				width: var(--container-width);
				height: 60px;
				background: var(--taskbar-background);
				backdrop-filter: blur(10px);
				border: 1px solid var(--border-color);
				border-radius: var(--border-radius);
				display: flex;
				justify-content: space-between;
				align-items: center;
				padding: 0 var(--spacing-normal);
				z-index: 1000;
				overflow-x: visible;
			}

			.taskbar-left {
				display: flex;
				align-items: center;
				gap: 10px;
			}

			.brand {
				font-size: 20px;
				font-weight: 700;
				cursor: pointer;
				color: var(--primary-color);
				transition: opacity 0.3s ease;
			}

			.brand:hover {
				opacity: 0.8;
			}

			.preview-tag {
				font-size: 14px;
				color: var(--primary-color);
				opacity: 0.7;
			}

			.taskbar button {
				background: var(--button-background);
				border: 1px solid var(--border-color);
				color: var(--primary-color);
				padding: 8px 15px;
				border-radius: 30px;
				cursor: pointer;
				margin-left: 10px;
				transition: all 0.3s ease;
			}

			.taskbar button:hover {
				background: var(--button-hover-background);
				transform: translateY(-1px);
			}

			.chat-input-container button,
			.theme-selector button {
				background: var(--button-background);
				border: 1px solid var(--border-color);
				color: var(--primary-color);
				padding: 8px 15px;
				border-radius: 30px;
				cursor: pointer;
				transition: all 0.3s ease;
			}

			.chat-input-container button:hover,
			.theme-selector button:hover {
				background: var(--button-hover-background);
				transform: translateY(-1px);
			}

			.chat-messages {
				display: flex;
				flex-direction: column;
				gap: var(--spacing-normal);
				padding: var(--spacing-normal);
				height: 100%;
				overflow-y: auto;
			}

			.chat-message {
				padding: var(--spacing-normal);
				border-radius: var(--border-radius-small);
				max-width: 85%;
				white-space: pre-wrap;
				font-size: clamp(14px, 3vw, 16px);
				backdrop-filter: blur(10px);
				border: 1px solid var(--border-color);
				transition: var(--transition);
				color: var(--primary-color);
			}

			.chat-message.user {
				background: var(--message-user-background);
				align-self: flex-end;
				border-bottom-right-radius: 5px;
			}

			.chat-message.bot {
				background: var(--message-background);
				align-self: flex-start;
				border-bottom-left-radius: 5px;
				color: var(--primary-color);
			}

			.chat-input-container {
				position: fixed;
				bottom: var(--spacing-normal);
				left: 50%;
				transform: translateX(-50%);
				width: var(--container-width);
				display: flex;
				gap: var(--spacing-small);
				background: var(--taskbar-background);
				backdrop-filter: blur(10px);
				padding: var(--spacing-normal);
				border-radius: var(--border-radius);
				border: 1px solid var(--border-color);
			}

			.chat-input-container textarea {
				flex: 1;
				background: var(--input-background);
				border: none;
				outline: none;
				color: var(--primary-color);
				font-size: 16px;
				padding: var(--spacing-small);
				border-radius: var(--border-radius-small);
				resize: none;
				min-height: 40px;
			}

			.chat-input-container input::placeholder {
				color: rgba(255, 255, 255, 0.5);
			}

			.chat-input-container button {
				background: var(--button-background);
				border: 1px solid var(--border-color);
				color: var(--primary-color);
				padding: 8px 20px;
				border-radius: 30px;
				cursor: pointer;
				transition: all 0.3s ease;
			}

			.chat-input-container button:hover {
				background: var(--button-hover-background);
				transform: translateY(-1px);
			}

			button {
				background: var(--button-background);
				border: 1px solid var(--border-color);
				color: var(--primary-color);
				padding: 8px 15px;
				border-radius: var(--border-radius);
				cursor: pointer;
				transition: var(--transition);
			}

			button:hover {
				background: var(--button-hover-background);
				transform: translateY(-1px);
			}

			.modal-overlay {
				position: fixed;
				inset: 0;
				background: rgba(0, 0, 0, 0.5);
				backdrop-filter: blur(5px);
				display: flex;
				justify-content: center;
				align-items: center;
				z-index: 2000;
				animation: fadeIn 0.3s ease;
			}

			.modal-window {
				background: var(--modal-background);
				backdrop-filter: blur(10px);
				border: 1px solid var(--border-color);
				border-radius: var(--border-radius);
				width: var(--container-width);
				padding: var(--spacing-normal);
				color: var(--primary-color);
				animation: slideUp 0.3s ease;
			}

			.modal-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 20px;
			}

			.modal-title {
				font-size: 24px;
				font-weight: 700;
			}

			.modal-content {
				line-height: 1.6;
				font-size: 16px;
			}

			.modal-content p {
				margin: 5px 0;
			}

			.settings-content {
				display: flex;
				flex-direction: column;
				gap: 15px;
			}

			.settings-button {
				background: var(--button-background);
				border: 1px solid var(--border-color);
				padding: 15px;
				border-radius: 15px;
				cursor: pointer;
				transition: all 0.3s ease;
				display: flex;
				align-items: center;
				gap: 10px;
			}

			.settings-button:hover {
				background: var(--button-hover-background);
				transform: translateX(5px);
			}

			.settings-button i {
				width: 20px;
				text-align: center;
			}

			.notification {
				position: fixed;
				bottom: 100px;
				left: 50%;
				transform: translateX(-50%);
				background: var(--background-color);
				color: var(--primary-color);
				padding: 12px 25px;
				border-radius: 30px;
				backdrop-filter: blur(10px);
				animation: slideUp 0.3s ease;
				z-index: 2000;
			}

			.notification.fade-out {
				animation: fadeOut 0.3s ease;
			}

			.code-block {
				background: rgba(0, 0, 0, 0.6);
				border-radius: 10px;
				padding: 15px;
				margin: 10px 0;
				position: relative;
			}

			.code-block pre {
				margin: 0;
				white-space: pre-wrap;
				font-family: 'Fira Code', monospace;
				color: #e0e0e0;
			}

			.copy-button {
				position: absolute;
				top: 5px;
				right: 5px;
				background: rgba(255, 255, 255, 0.1);
				border: 1px solid var(--border-color);
				color: white;
				padding: 5px 10px;
				border-radius: 15px;
				cursor: pointer;
				font-size: 12px;
			}

			.message-actions {
				display: flex;
				gap: 5px;
				margin-top: 5px;
				opacity: 0;
				transition: opacity 0.3s ease;
			}

			.chat-message:hover .message-actions {
				opacity: 1;
			}

			.action-button {
				background: var(--button-background);
				border: var(--border);
				color: var(--primary-color);
				padding: 3px 8px;
				border-radius: 12px;
				cursor: pointer;
				font-size: 12px;
			}

			.edit-mode {
				border: var(--border-color);
			}

			.edit-input {
				width: 100%;
				background: transparent;
				border: none;
				color: var(--primary-color);
				font-family: inherit;
				font-size: inherit;
				padding: 0;
				margin: 0;
				resize: none;
				outline: none;
			}

			.theme-selector {
				background: var(--button-background);
				border: 1px solid var(--border-color);
				color: var(--primary-color);
				padding: 8px 15px;
				border-radius: 15px;
				cursor: pointer;
				margin-left: 10px;
				transition: all 0.3s ease;
				font-size: 14px;
			}

			.theme-selector:hover {
				background: var(--button-hover-background);
			}

			.theme-selector select {
				background: transparent;
				border: none;
				color: var(--primary-color);
				font-size: inherit;
				outline: none;
				padding: 5px;
				cursor: pointer;
			}

			.theme-selector select:focus {
				border: 1px solid var(--secondary-color);
			}

			.theme-selector option {
				background: var(--background-color);
				color: var(--primary-color);
				padding: 10px;
			}

			.theme-selector option:hover {
				background: var(--secondary-color);
				color: var(--color);
			}

			.theme-selector option[selected] {
				background: var(--secondary-color);
				color: var(--color);
			}

			.message-timestamp {
				font-size: 11px;
				opacity: 0.7;
				margin-top: 5px;
			}

			.container {
				position: fixed;
				top: calc(80px + var(--spacing-normal));
				bottom: calc(80px + var(--spacing-normal));
				left: 50%;
				transform: translateX(-50%);
				width: var(--container-width);
				max-width: var(--container-max-width);
				overflow-y: auto;
				padding-right: 15px;
			}

			.chat-messages {
				display: flex;
				flex-direction: column;
				gap: 15px;
				padding: 20px;
				padding-bottom: 40px;
				height: 100%;
				overflow-y: auto;
			}

			.chat-input-container {
				position: fixed;
				bottom: var(--spacing-normal);
				left: 50%;
				transform: translateX(-50%);
				width: var(--container-width);
				max-width: var(--container-max-width);
				display: flex;
				gap: 10px;
				background: var(--chat-input-container-background);
				backdrop-filter: blur(10px);
				padding: var(--spacing-normal);
				border-radius: 30px;
				border: 1px solid var(--border-color);
			}

			.chat-input-container textarea {
				flex: 1;
				background: transparent;
				border: none;
				outline: none;
				color: var(--color);
				font-size: 16px;
				padding: 10px;
				border-radius: 10px;
				resize: none;
				min-height: 40px;
			}

			.chat-input-container input::placeholder {
				color: var(--color);
			}

			.chat-input-container button {
				background: rgba(255, 255, 255, 0.1);
				border: 1px solid rgba(255, 255, 255, 0.2);
				color: var(--color);
				padding: 8px 20px;
				border-radius: 30px;
				cursor: pointer;
				transition: all 0.3s ease;
			}

			.chat-input-container button:hover {
				background: rgba(255, 255, 255, 0.2);
				transform: translateY(-1px);
			}

			@keyframes fadeIn {
				from {
					opacity: 0;
				}

				to {
					opacity: 1;
				}
			}

			@keyframes slideUp {
				from {
					transform: translateY(20px);
					opacity: 0;
				}

				to {
					transform: translateY(0);
					opacity: 1;
				}
			}

			@keyframes messageAppear {
				from {
					transform: translateY(10px);
					opacity: 0;
				}

				to {
					transform: translateY(0);
					opacity: 1;
				}
			}

			@keyframes fadeOut {
				to {
					opacity: 0;
					transform: translate(-50%, 20px);
				}
			}

			@media (max-width: 768px) {
				:root {
					--container-width: 95%;
					--spacing-normal: 15px;
					--spacing-small: 8px;
					--font-size-base: 14px;
				}

				body {
					font-size: var(--font-size-base);
					margin: 0;
					padding: 0;
					box-sizing: border-box;
				}

				.container {
					position: absolute;
					top: 80px;
					bottom: 80px;
					left: 50%;
					transform: translateX(-50%);
					width: var(--container-width);
					max-width: 100%;
					padding-right: var(--spacing-small);
					overflow-y: auto;
					display: flex;
					flex-direction: column;
					align-items: center;
				}

				.taskbar {
					width: 100%;
					padding: 10px var(--spacing-normal);
					display: flex;
					justify-content: space-between;
					align-items: center;
					box-sizing: border-box;
				}

				.taskbar-left {
					display: flex;
					align-items: center;
					gap: 8px;
					flex-wrap: wrap;
				}

				.brand {
					font-size: 18px;
				}

				.preview-tag {
					font-size: 12px;
				}

				.chat-input-container {
					width: 100%;
					position: absolute;
					bottom: var(--spacing-normal);
					left: 50%;
					transform: translateX(-50%);
					display: flex;
					gap: var(--spacing-small);
					background: var(--chat-input-container-background);
					backdrop-filter: blur(10px);
					padding: var(--spacing-normal);
					border-radius: var(--border-radius);
					border: 1px solid var(--border-color);
					box-sizing: border-box;
				}

				.chat-input-container textarea {
					font-size: 14px;
					padding: 8px;
					min-height: 40px;
					flex: 1;
					box-sizing: border-box;
				}

				.chat-input-container button {
					padding: 6px 12px;
				}

				.chat-messages {
					width: 100%;
					padding: var(--spacing-normal);
					padding-bottom: 60px;
					display: flex;
					flex-direction: column;
					gap: 10px;
					box-sizing: border-box;
					overflow-y: auto;
				}

				.chat-message {
					padding: var(--spacing-small);
					font-size: 14px;
					max-width: 95%;
					white-space: pre-wrap;
					backdrop-filter: blur(10px);
					border-radius: 10px;
					box-sizing: border-box;
					display: inline-block;
				}

				.chat-message.user {
					align-self: flex-end;
					background-color: var(--user-message-bg);
					color: var(--user-message-color);
				}

				.chat-message.bot {
					align-self: flex-start;
					background-color: var(--bot-message-bg);
					color: var(--bot-message-color);
				}

				.modal-window {
					padding: var(--spacing-normal);
				}

				.modal-title {
					font-size: 20px;
				}

				.modal-content {
					font-size: 14px;
				}

				.theme-selector {
					font-size: 12px;
					padding: 6px 12px;
					margin-left: 0;
				}

				.notification {
					font-size: 14px;
					padding: 10px 20px;
				}
			}

			@media (max-width: 480px) {
				:root {
					--container-width: 98%;
					--spacing-normal: 10px;
					--spacing-small: 5px;
					--font-size-base: 12px;
				}

				body {
					font-size: var(--font-size-base);
				}

				.container {
					position: absolute;
					top: 60px;
					bottom: 60px;
					left: 50%;
					transform: translateX(-50%);
					width: var(--container-width);
					padding-right: var(--spacing-small);
					overflow-y: auto;
					display: flex;
					flex-direction: column;
					align-items: center;
				}

				.taskbar {
					width: 100%;
					padding: 8px var(--spacing-small);
					display: flex;
					justify-content: space-between;
					align-items: center;
				}

				.taskbar button {
					padding: 5px 10px;
					font-size: 13px;
				}

				.brand {
					font-size: 11px;
				}

				.preview-tag {
					font-size: 8px;
				}

				.chat-input-container {
					width: 100%;
					padding: 8px;
				}

				.chat-input-container textarea {
					font-size: 12px;
					padding: 6px;
					min-height: 30px;
				}

				.chat-input-container button {
					padding: 5px 12px;
				}

				.chat-messages {
					width: 100%;
					padding: var(--spacing-small);
					padding-bottom: 50px;
					display: flex;
					flex-direction: column;
					gap: 8px;
				}

				.chat-message {
					font-size: 12px;
					padding: 10px 12px;
					max-width: 95%;
					white-space: pre-wrap;
					display: inline-block;
				}

				.modal-window {
					padding: 12px;
				}

				.modal-title {
					font-size: 18px;
				}

				.modal-content {
					font-size: 12px;
				}

				.theme-selector {
					font-size: 10px;
					padding: 5px 10px;
				}

				.notification {
					font-size: 13px;
					padding: 8px 15px;
				}
			}

			@media (hover: none) {

				.chat-input-container button,
				.taskbar button,
				.settings-button {
					transition: none;
				}

				.chat-input-container button:active,
				.taskbar button:active,
				.settings-button:active {
					background: rgba(255, 255, 255, 0.2);
				}
			}
		</style>
	</head>
	<body>
		<!-- Taskbar with improved structure -->
		<div class="taskbar">
			<div class="taskbar-left">
				<span class="brand">PatheticAI</span>
				<span class="preview-tag">Enhanced Edition</span>
				<select class="theme-selector" id="themeSelect">
					<option value="dark">Dark Theme</option>
					<option value="light">Light Theme</option>
				</select>
			</div>
			<div class="taskbar-right">
				<button onclick="showSettingsModal()" title="Settings">
					<i class="fas fa-cog"></i>
				</button>
				<button onclick="toggleFullscreen()" title="Toggle Fullscreen">
					<i class="fas fa-expand"></i>
				</button>
				<button onclick="contactEmail()" title="Join Discord">
					<i class="fa-brands fa-discord"></i>
				</button>
			</div>
		</div>
		<!-- Main chat container -->
		<div class="container">
			<div class="chat-messages"></div>
		</div>
		<!-- Enhanced chat input -->
		<div class="chat-input-container">
			<textarea id="messageInput" placeholder="Type your message..." rows="1" maxlength="2000"></textarea>
			<button onclick="sendMessage()" title="Send Message">
				<i class="fas fa-paper-plane"></i>
			</button>
		</div>
		<!-- Enhanced JavaScript -->
		<script>
			const STORAGE_KEYS = {
				THEME: 'theme',
				API_KEY: 'openRouterApiKey',
				MESSAGES: 'chatMessages',
				LANGUAGE: 'preferredLanguage'
			};
			// Initialize message history from localStorage
			let messageHistory = [];
			try {
				const savedMessages = localStorage.getItem(STORAGE_KEYS.MESSAGES);
				if (savedMessages) {
					messageHistory = JSON.parse(savedMessages);
					// Restore saved messages to the chat interface on load
					document.addEventListener('DOMContentLoaded', () => {
						messageHistory.forEach(msg => {
							const isUser = msg.role === "user";
							const {
								element
							} = createMessageElement(msg.content, isUser, new Date(msg.timestamp));
							document.querySelector('.chat-messages').appendChild(element);
						});
					});
				}
			} catch (e) {
				console.error('Error loading message history:', e);
				messageHistory = [];
			}
			let currentLanguage = localStorage.getItem(STORAGE_KEYS.LANGUAGE) || 'English';
			let isWaitingForResponse = false;
			let editingMessageId = null;
			const themeSelect = document.getElementById('themeSelect');
			themeSelect.addEventListener('change', function() {
				const newTheme = this.value;
				document.documentElement.setAttribute('data-theme', newTheme);
				localStorage.setItem(STORAGE_KEYS.THEME, newTheme);
			});
			const savedTheme = localStorage.getItem(STORAGE_KEYS.THEME) || 'dark';
			document.documentElement.setAttribute('data-theme', savedTheme);
			themeSelect.value = savedTheme;
			const textarea = document.getElementById('messageInput');
			textarea.addEventListener('keydown', function(e) {
				if (e.key === 'Enter' && !e.shiftKey) {
					e.preventDefault();
					sendMessage();
				}
			});
			textarea.addEventListener('input', function() {
				this.style.height = 'auto';
				this.style.height = `${this.scrollHeight}px`;
				if (this.scrollHeight > 150) {
					this.style.height = '150px';
					this.style.overflowY = 'auto';
				}
			});
			const models = [{
				name: "google/gemini-2.0-flash-exp:free"
			}, {
				name: "meta-llama/llama-3.2-3b-instruct:free"
			}, {
				name: "qwen/qwen-2-7b-instruct:free"
			}, {
				name: "microsoft/phi-3-medium-128k-instruct:free"
			}, {
				name: "undi95/toppy-m-7b:free"
			}, {
				name: "google/gemini-2.0-flash-thinking-exp:free"
			}, {
				name: "microsoft/phi-3-mini-128k-instruct:free"
			}];
			const systemMessage = {
				role: "system",
				content: `
  You are PatheticAI, a chatbot designed to be helpful, friendly, and empathetic.
  [Traits description here]
  `
			};

			function formatTimestamp(date) {
				return `${date.toLocaleTimeString()} ${date.toLocaleDateString()}`;
			}

			function createMessageElement(message, isUser, timestamp = new Date()) {
				const messageId = timestamp.getTime().toString();
				const messageElement = document.createElement('div');
				messageElement.classList.add('chat-message');
				messageElement.classList.add(isUser ? 'user' : 'bot');
				messageElement.dataset.messageId = messageId;
				const contentDiv = document.createElement('div');
				contentDiv.classList.add('message-content');
				// Process markdown and code blocks
				if (!isUser) {
					let processedContent = message;
					// Handle code blocks first
					const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
					processedContent = processedContent.replace(codeBlockRegex, (match, language, code) => {
						const codeBlockDiv = document.createElement('div');
						codeBlockDiv.className = 'code-block';
						const pre = document.createElement('pre');
						const codeElement = document.createElement('code');
						if (language) {
							codeElement.className = `language-${language}`;
						}
						codeElement.textContent = code.trim();
						pre.appendChild(codeElement);
						const copyButton = document.createElement('button');
						copyButton.className = 'copy-button';
						copyButton.innerHTML = ' < i class = "fas fa-copy" > < /i>';
						copyButton.onclick = () => copyToClipboard(code.trim());
						codeBlockDiv.appendChild(pre);
						codeBlockDiv.appendChild(copyButton);
						const wrapper = document.createElement('div');
						wrapper.appendChild(codeBlockDiv);
						return wrapper.innerHTML;
					});
					// Process other markdown elements
					processedContent = processMarkdown(processedContent);
					contentDiv.innerHTML = processedContent;
				} else {
					contentDiv.textContent = message;
				}
				messageElement.appendChild(contentDiv);
				const timestampDiv = document.createElement('div');
				timestampDiv.className = 'message-timestamp';
				timestampDiv.textContent = formatTimestamp(timestamp);
				messageElement.appendChild(timestampDiv);
				const actionsDiv = document.createElement('div');
				actionsDiv.className = 'message-actions';
				if (isUser) {
					const editButton = document.createElement('button');
					editButton.className = 'action-button';
					editButton.innerHTML = ' < i class = "fas fa-edit" > < /i>';
					editButton.onclick = () => startEditing(messageId);
					actionsDiv.appendChild(editButton);
				}
				const copyButton = document.createElement('button');
				copyButton.className = 'action-button';
				copyButton.innerHTML = ' < i class = "fas fa-copy" > < /i>';
				copyButton.onclick = () => copyToClipboard(message);
				actionsDiv.appendChild(copyButton);
				messageElement.appendChild(actionsDiv);
				return {
					element: messageElement,
					id: messageId
				};
			}

			function processMarkdown(text) {
				// Headers
				text = text.replace(/^(#{1,6})\s*(.*?)$/gm, (match, hashes, content) => {
					const level = hashes.length;
					return `
																	<h${level}>${content}</h${level}>`;
				});
				// Bold
				text = text.replace(/\*\*(.*?)\*\*/g, ' < strong > $1 < /strong>');
						// Italic
						text = text.replace(/\*(.*?)\*/g, ' < em > $1 < /em>');
							// Lists
							text = text.replace(/^-\s*(.*?)$/gm, ' < li > $1 < /li>');
								text = text.replace(/( < li > .* ? < \/li>)\n?/gs, ' < ul > $1 < /ul>');
									return text;
								}
								async function copyToClipboard(text) {
									try {
										await navigator.clipboard.writeText(text);
										showNotification('Copied to clipboard');
									} catch (err) {
										showNotification('Failed to copy to clipboard');
										console.error('Copy failed:', err);
									}
								}

								function startEditing(messageId) {
									if (isWaitingForResponse) return;
									const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
									const contentDiv = messageElement.querySelector('.message-content');
									const originalText = contentDiv.textContent;
									const textarea = document.createElement('textarea');
									textarea.className = 'edit-input';
									textarea.value = originalText;
									textarea.rows = originalText.split('\n').length;
									contentDiv.innerHTML = '';
									contentDiv.appendChild(textarea);
									messageElement.classList.add('edit-mode');
									textarea.focus();
									textarea.onkeydown = (e) => {
										if (e.key === 'Enter' && !e.shiftKey) {
											e.preventDefault();
											finishEditing(messageId, textarea.value);
										} else if (e.key === 'Escape') {
											finishEditing(messageId, originalText);
										}
									};
								}

								function finishEditing(messageId, newText) {
									const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
									const contentDiv = messageElement.querySelector('.message-content');
									contentDiv.textContent = newText;
									messageElement.classList.remove('edit-mode');
									// Update message history
									const messageIndex = messageHistory.findIndex(msg => msg.role === "user" && msg.timestamp.toString() === messageId);
									if (messageIndex !== -1) {
										messageHistory[messageIndex].content = newText;
										// Save updated history to localStorage
										localStorage.setItem(STORAGE_KEYS.MESSAGES, JSON.stringify(messageHistory));
									}
								}
								async function sendMessage() {
									const textarea = document.getElementById('messageInput');
									const message = textarea.value.trim();
									const sendButton = document.querySelector('.chat-input-container button');
									if (!message || isWaitingForResponse) return;
									isWaitingForResponse = true;
									textarea.disabled = true;
									sendButton.disabled = true;
									const timestamp = new Date();
									const userMessage = {
										role: "user",
										content: message,
										timestamp: timestamp.getTime()
									};
									messageHistory.push(userMessage);
									const {
										element: messageElement
									} = createMessageElement(message, true, timestamp);
									document.querySelector('.chat-messages').appendChild(messageElement);
									messageElement.scrollIntoView({
										behavior: 'smooth'
									});
									textarea.value = '';
									textarea.style.height = 'auto';
									const loadingElement = document.createElement('div');
									loadingElement.classList.add('chat-message', 'bot', 'typing');
									loadingElement.textContent = 'Typing...';
									document.querySelector('.chat-messages').appendChild(loadingElement);
									try {
										const response = await tryMultipleModels(message);
										loadingElement.remove();
										if (response.text) {
											const botMessage = {
												role: "assistant",
												content: response.text,
												timestamp: Date.now()
											};
											messageHistory.push(botMessage);
											// Save to localStorage after each message
											localStorage.setItem(STORAGE_KEYS.MESSAGES, JSON.stringify(messageHistory));
											const {
												element: botElement
											} = createMessageElement(response.text, false, new Date());
											document.querySelector('.chat-messages').appendChild(botElement);
											botElement.scrollIntoView({
												behavior: 'smooth'
											});
											// Apply syntax highlighting
											botElement.querySelectorAll('pre code').forEach((block) => {
												hljs.highlightElement(block);
											});
										}
									} catch (error) {
										loadingElement.remove();
										showError(error.message);
										const {
											element: errorElement
										} = createMessageElement(`Error: ${error.message}`, false);
										document.querySelector('.chat-messages').appendChild(errorElement);
									} finally {
										isWaitingForResponse = false;
										textarea.disabled = false;
										sendButton.disabled = false;
										textarea.focus();
									}
								}
								async function tryMultipleModels(userMessage) {
									const timeout = 2000000;
									const apiKey = getApiKey();
									if (!apiKey) {
										checkAndStoreApiKey();
										throw new Error("API key not found. Please enter your API key first.");
									}
									for (let modelIndex = 0; modelIndex < models.length; modelIndex++) {
										try {
											const response = await Promise.race([
												fetch("https://openrouter.ai/api/v1/chat/completions", {
													method: "POST",
													headers: {
														"Authorization": `Bearer ${apiKey}`,
														"Content-Type": "application/json",
													},
													body: JSON.stringify({
														"model": models[modelIndex].name,
														"messages": [
															systemMessage, ...messageHistory.filter(msg => msg.role === "user" || msg.role === "assistant"), {
																role: "user",
																content: `Please respond in ${currentLanguage}. ${userMessage}`
															}
														]
													})
												}).then(async res => {
													if (!res.ok) {
														const errorData = await res.json();
														throw new Error(`API Error: ${errorData.error?.message || 'Unknown error'}`);
													}
													return res.json();
												}),
												new Promise((_, reject) => setTimeout(() => reject(new Error('Request timeout')), timeout))
											]);
											if (response.choices && response.choices[0].message.content) {
												return {
													text: response.choices[0].message.content
												};
											}
										} catch (error) {
											console.error(`Model ${models[modelIndex].name} failed:`, error);
											if (modelIndex === models.length - 1) {
												throw new Error(`API Error: ${error.message}`);
											}
											continue;
										}
									}
									throw new Error("All API attempts failed. Please try again later.");
								}

								function showWelcomeModal() {
									const modal = document.createElement('div');
									modal.className = 'modal-overlay';
									modal.innerHTML = `
        
														
															
																		<div class="modal-window">
																			<div class="modal-header">
																				<span class="modal-title">Welcome to PatheticAI Enhanced</span>
																			</div>
																			<div class="modal-content">
																				<p>API version: 1.0</p>
																				<p>PatheticAI version: 1.0 Enhanced</p>
																				<p>Created by: Pathetic</p>
																				<br>
																					<p>New Features:</p>
																					<ul>
																						<li>Edit messages with the edit button</li>
																						<li>Copy messages and code blocks</li>
																						<li>Syntax highlighting for code</li>
																						<li>Dark/Light theme toggle</li>
																						<li>Improved UI and responsiveness</li>
																						<li>Persistent chat history</li>
																					</ul>
																					<br>
																						<p>Click outside this popup to close it.</p>
																					</div>
																				</div>
    `;
									modal.addEventListener('click', (e) => {
										if (e.target === modal) {
											modal.remove();
										}
									});
									document.body.appendChild(modal);
								}

								function showSettingsModal() {
									const modal = document.createElement('div');
									modal.className = 'modal-overlay';
									modal.innerHTML = `

															
																
																	
																				<div class="modal-window">
																					<div class="modal-header">
																						<span class="modal-title">Settings</span>
																					</div>
																					<div class="modal-content settings-content">
																						<div class="settings-button" onclick="resetChat()">
																							<i class="fas fa-redo"></i>
                    Reset Chat

																	
																		
																			
																						</div>
																						<div class="settings-button" onclick="changeLanguage()">
																							<i class="fas fa-language"></i>
                    Language: ${currentLanguage}

																	
																		
																			
																						</div>
																						<div class="settings-button" onclick="removeApiKey()">
																							<i class="fas fa-key"></i>
                    Remove API Key

																	
																		
																			
																						</div>
																						<div class="settings-button" onclick="closeApp()">
																							<i class="fas fa-times"></i>
                    Close App

																	
																		
																			
																						</div>
																					</div>
																				</div>
    `;
									modal.addEventListener('click', (e) => {
										if (e.target === modal) {
											modal.remove();
										}
									});
									document.body.appendChild(modal);
								}

								function showAboutModal() {
									const modal = document.createElement('div');
									modal.className = 'modal-overlay';
									modal.innerHTML = `

															
																
																	
																				<div class="modal-window">
																					<div class="modal-header">
																						<span class="modal-title">About PatheticAI</span>
																					</div>
																					<div class="modal-content">
																						<p>PatheticAI: 1.0 Enhanced</p>
																						<p>API version: 1.0</p>
																						<p>Contact: https:

																		
																			
																				
																							<br>
																								<p>Enhanced Features:</p>
																								<ul>
																									<li>Improved message handling</li>
																									<li>Better code display and copying</li>
																									<li>Theme customization</li>
																									<li>Advanced editing capabilities</li>
																									<li>Persistent chat history</li>
																								</ul>
																							</div>
																						</div>
    `;
									modal.addEventListener('click', (e) => {
										if (e.target === modal) {
											modal.remove();
										}
									});
									document.body.appendChild(modal);
								}

								function removeApiKey() {
									if (confirm('Are you sure you want to remove your API key? You will need to enter a new key to use PatheticAI.')) {
										localStorage.removeItem(STORAGE_KEYS.API_KEY);
										showNotification('API key removed');
										setTimeout(() => {
											window.location.reload();
										}, 1000);
									}
								}

								function resetChat() {
									if (confirm('Are you sure you want to reset the chat? This will clear all messages.')) {
										document.querySelector('.chat-messages').innerHTML = '';
										messageHistory = [];
										localStorage.setItem(STORAGE_KEYS.MESSAGES, JSON.stringify(messageHistory));
										systemMessage.content = `You are PatheticAI.

Key characteristics:
1. Offering clear and concise guidance
2. Being adaptable to various topics and tasks
3. Responding in a manner that is both informative and easy to understand
4. Assisting users with technical support or queries
5. Promoting user satisfaction by being patient and approachable
`;
										showNotification('Chat reset successful');
									}
								}

								function changeLanguage() {
									const newLanguage = prompt('Enter your preferred language:', currentLanguage);
									if (newLanguage && newLanguage.trim() !== '') {
										currentLanguage = newLanguage.trim();
										localStorage.setItem(STORAGE_KEYS.LANGUAGE, currentLanguage);
										systemMessage.content = `${systemMessage.content.split('Please always respond in')[0]}Please always respond in ${currentLanguage}.`;
										showNotification(`Language changed to: ${currentLanguage}`);
									}
								}

								function closeApp() {
									if (confirm('Are you sure you want to close PatheticAI?')) {
										window.close();
									}
								}

								function getApiKey() {
									return localStorage.getItem(STORAGE_KEYS.API_KEY);
								}

								function checkAndStoreApiKey() {
									const storedApiKey = getApiKey();
									if (!storedApiKey) {
										const modal = document.createElement('div');
										modal.className = 'modal-overlay';
										modal.innerHTML = `
            
																	
																			
																						<div class="modal-window">
																							<div class="modal-header">
																								<span class="modal-title">Openrouter API key required!</span>
																							</div>
																							<div class="modal-content">
																								<p>To use PatheticAI, an API key from Openrouter is required. To get this, go to</p>
																								<a href="https://openrouter.ai/settings/keys" target="_blank" style="color: white;">https://openrouter.ai/settings/keys</a>
																							</p>
																							<br>
																								<input type="text" id="apiKeyInput" placeholder="Your API Key Here" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 15px; color: white;">
																									<br>
																										<br>
																											<button onclick="saveApiKey()" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 15px; color: white; cursor: pointer;">Start up</button>
																										</div>
																									</div>
        `;
										document.body.appendChild(modal);
										return false;
									}
									return true;
								}

								function saveApiKey() {
									const apiKey = document.getElementById('apiKeyInput').value.trim();
									if (apiKey && apiKey.startsWith('sk-or-')) {
										localStorage.setItem(STORAGE_KEYS.API_KEY, apiKey);
										document.querySelector('.modal-overlay').remove();
										showNotification('Booting...');
										setTimeout(() => {
											window.location.reload();
										}, 1000);
									} else {
										showNotification('API key not suitable for PatheticAI...');
									}
								}

								function showNotification(message) {
									const notification = document.createElement('div');
									notification.className = 'notification';
									notification.textContent = message;
									document.body.appendChild(notification);
									setTimeout(() => {
										notification.classList.add('fade-out');
										setTimeout(() => notification.remove(), 300);
									}, 2000);
								}

								function toggleFullscreen() {
									if (!document.fullscreenElement) {
										document.documentElement.requestFullscreen();
									} else {
										document.exitFullscreen();
									}
								}

								function contactEmail() {
									window.open('https://discord.gg/Hb5ccPY3XV', '_blank');
								}
								document.addEventListener('DOMContentLoaded', () => {
									showWelcomeModal();
									showNotification('PatheticAI V1.0 Enhanced');
									if (!checkAndStoreApiKey()) {
										textarea.disabled = true;
										document.querySelector('.chat-input-container button').disabled = true;
									}
									document.querySelector('.brand').addEventListener('click', showAboutModal);
									if (typeof hljs !== 'undefined') {
										document.querySelectorAll('pre code').forEach((block) => {
											hljs.highlightElement(block);
										});
									}
									if ('serviceWorker' in navigator) {
										window.addEventListener('load', () => {
											navigator.serviceWorker.register('/service-worker.js').then(registration => {
												console.log('Service Worker registered with scope:', registration.scope);
											}).catch(error => {
												console.log('Service Worker registration failed:', error);
											});
										});
									}
								});
		</script>
	</body>
</html>
